name: HUMINEX Pipeline Status to Slack

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  workflow_run:
    workflows:
      - HUMINEX Backend CI
      - HUMINEX Backend Image Push
      - HUMINEX CodeQL
      - HUMINEX E2E Playwright
      - OpenHuman Backend CI
      - Frontend CI
      - HUMINEX Infra Deploy
    types:
      - completed

jobs:
  send-slack-summary:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    steps:
      - name: Validate Slack webhook configuration
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "Missing required secret: SLACK_WEBHOOK_URL"
            exit 1
          fi

      - name: Send compact pipeline card to Slack
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL_MENTION: ${{ secrets.SLACK_CHANNEL_MENTION }}
        run: |
          set -euo pipefail

          now_utc="$(date -u +"%Y-%m-%d %H:%M UTC")"
          actions_url="https://github.com/${REPO}/actions"

          get_latest_run() {
            local workflow_file="$1"
            curl -fsSL \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${REPO}/actions/workflows/${workflow_file}/runs?per_page=1"
          }

          status_emoji() {
            local status="$1"
            local conclusion="$2"
            if [ "$status" = "in_progress" ]; then echo "ðŸŸ¡"; return; fi
            if [ "$status" = "queued" ]; then echo "ðŸ”µ"; return; fi
            case "$conclusion" in
              success) echo "ðŸŸ¢" ;;
              failure) echo "ðŸ”´" ;;
              cancelled) echo "âš«" ;;
              skipped) echo "âšª" ;;
              *) echo "âšª" ;;
            esac
          }

          status_label() {
            local status="$1"
            local conclusion="$2"
            if [ "$status" = "in_progress" ]; then echo "Running"; return; fi
            if [ "$status" = "queued" ]; then echo "Queued"; return; fi
            case "$conclusion" in
              success) echo "Success" ;;
              failure) echo "Failed" ;;
              cancelled) echo "Cancelled" ;;
              skipped) echo "Skipped" ;;
              *) echo "Unknown" ;;
            esac
          }

          workflows=(
            "frontend-ci.yml|Frontend CI"
            "backend-ci.yml|Backend CI"
            "backend-image-push.yml|Backend Image Push"
            "e2e-playwright.yml|E2E Playwright"
            "openhuman-backend-ci.yml|OpenHuman Backend CI"
            "codeql.yml|CodeQL"
            "infra-deploy.yml|Infra Deploy"
          )

          blocks='[]'

          if [ -n "${SLACK_CHANNEL_MENTION:-}" ]; then
            blocks=$(echo "$blocks" | jq --arg mention "$SLACK_CHANNEL_MENTION" '. + [{"type":"section","text":{"type":"mrkdwn","text":$mention}}]')
          fi

          blocks=$(echo "$blocks" | jq --arg now "$now_utc" --arg repo "$REPO" --arg actions "$actions_url" '
            . + [
              {"type":"header","text":{"type":"plain_text","text":"HUMINEX CI/CD Snapshot"}},
              {"type":"context","elements":[
                {"type":"mrkdwn","text":("*Repo:* " + $repo)},
                {"type":"mrkdwn","text":("*Time:* " + $now)},
                {"type":"mrkdwn","text":("<" + $actions + "|Open GitHub Actions>")}
              ]},
              {"type":"divider"}
            ]
          ')

          for item in "${workflows[@]}"; do
            wf_file="${item%%|*}"
            wf_name="${item##*|}"

            run_json="$(get_latest_run "$wf_file")"
            status="$(echo "$run_json" | jq -r '.workflow_runs[0].status // "unknown"')"
            conclusion="$(echo "$run_json" | jq -r '.workflow_runs[0].conclusion // "unknown"')"
            branch="$(echo "$run_json" | jq -r '.workflow_runs[0].head_branch // "-"')"
            run_no="$(echo "$run_json" | jq -r '.workflow_runs[0].run_number // 0')"
            url="$(echo "$run_json" | jq -r '.workflow_runs[0].html_url // "https://github.com/'"${REPO}"'/actions"')"

            emoji="$(status_emoji "$status" "$conclusion")"
            label="$(status_label "$status" "$conclusion")"

            blocks=$(echo "$blocks" | jq \
              --arg wf "$wf_name" \
              --arg branch "$branch" \
              --arg run_no "$run_no" \
              --arg emoji "$emoji" \
              --arg label "$label" \
              --arg url "$url" '
                . + [
                  {"type":"section","text":{"type":"mrkdwn","text":("*" + $wf + "*\n" + $emoji + " *" + $label + "*  â€¢  branch: `" + $branch + "`  â€¢  run: #" + $run_no)}},
                  {"type":"actions","elements":[{"type":"button","text":{"type":"plain_text","text":"Navigate"},"url":$url}]},
                  {"type":"divider"}
                ]
              ')
          done

          payload=$(jq -n --arg text "HUMINEX CI/CD Snapshot" --argjson blocks "$blocks" '{text:$text, blocks:$blocks}')
          curl -fsSL -X POST -H "Content-Type: application/json" --data "$payload" "$SLACK_WEBHOOK_URL" >/dev/null
          echo "Slack snapshot sent successfully."
